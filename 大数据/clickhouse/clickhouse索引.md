## 一级索引

clickhouse的一级，只需要记录每一个block第一个值即可。

例如一组一亿行的数据，主键范围从1～100,000,000。存储到clickhouse后按照8192行为一个block，那么一共有12208个block。

索引为1，8193，16635……在查询时只需要就可以根据值确定到需要读取哪几个block了。例如我需要查询id>500 and id <12258的数据，那就只需要读取第0块和第1块block即可。

**在clickhouse的数据存储文件中，一级索引存在于primary.idx中**

一级索引的本质是存储了每个block中数据的最小值，从而为确定需要查询的数据确定好其所在的block。它简历了数据到block的映射关系。简单来说，给定一个数据，通过一级索引能够快速查询到这个数据所在的block。从而避免查询一个数据需要遍历整个数据集。



## 标记

一级索引并不能单独实现快速查找的目标。或者说，一级索引只实现了数据到block的映射。但还存在一个问题，我即使已经知道我的数据存储在了第一个block，那我如何定位到这个block的位置呢？这个问题的答案就需要通过标记文件来实现。换句话说，标记文件存储了block到文件偏移量的映射。

这个问题其实也不难理解，我们知道一个block是8192行数据组成的。如果每个block的大小都是64M。那么找到第N个block的地址就很容易，通过N*64m即可，但关键block经过压缩后是无法保证其大小的，也就是说每个block的大小是不同的。那么就必须将每个block的起始位置存储下来，方便查找。

在clickhouse的实际处理中，**每行标记有3个字段组成blockid,数据文件中的偏移量，压缩后块中偏移量**。每个字段是8字节，因此每个标记一共24字节。通过blockid可以N*24B快速定位到位置。

其实有blockid和数据文件中偏移量，就已经可以快读定位了，那么clickhouse标记文件中的第三项压缩后块中偏移量是用来做说明的呢？这个问题的答案其实和clickhouse对于压缩块的处理有关。

第三章已经提过，clickhouse默认按照每8192行生成一个block。但如果8192行的数据依然很小怎么办？例如UInt8类型，一行数据只有8位1字节。即使8192行数据也仅仅只有8192Byte=8KB。这个数据量用来压缩还是显得太小。因此，clickhouse在处理时，会按照每个压缩块最小64KB，最大1M的规则进行处理。即一个block数据总和小于64K时，会继续取下一个block。因此会出现多个block出现在一个压缩块中。标记文件中的第三个参数就是用来处理这种情况的。

因此假设一个标记文件的内容如下：

| 0    | 0     | 0     |
| ---- | ----- | ----- |
| 1    | 0     | 8192  |
| 2    | 0     | 16384 |
| 1    | 12016 | 0     |

标记文件内容

读取第2块block时，根据2*24Byte=48，定位到（2，0，16384）这一行，然后根据0，从bin文件中读取偏移量=0的数据块，经过解压缩后再根据16384读取解压缩后从16384开始的数据，即可找到对应的原始数据。



